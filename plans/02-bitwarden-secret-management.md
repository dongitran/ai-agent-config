# Brainstorm: Bitwarden-Based Secret Management for MCP

> Tá»± Ä‘á»™ng quáº£n lÃ½ secrets cho MCP servers báº±ng Bitwarden integration

**Version**: v2.6.0 (Future)  
**Created**: 2026-02-13  
**Status**: Brainstorming

---

## ğŸ¯ Problem Statement

### Current Challenges

1. **Security Risk**: MCP config files Ä‘Æ°á»£c push lÃªn GitHub public
   - KhÃ´ng thá»ƒ hardcode API keys, tokens trong config
   - `${ENV_VAR}` syntax yÃªu cáº§u user manually set env vars

2. **User Friction**: 
   - User pháº£i manually export env vars trÆ°á»›c khi start Antigravity
   - Má»—i mÃ¡y má»›i pháº£i setup láº¡i táº¥t cáº£ env vars
   - Dá»… quÃªn hoáº·c setup sai env var names

3. **No Central Management**:
   - Secrets scattered across different places
   - Hard to rotate/update keys
   - No audit trail

---

## ğŸ’¡ Proposed Solution

### High-Level Concept

**Use Bitwarden as the single source of truth for all MCP secrets**

**Workflow:**
```
1. User stores all secrets in Bitwarden vault
2. Package bundles Bitwarden MCP server (pre-configured)
3. On `ai-agent pull/install`:
   - Package scans all MCP configs
   - Detects required env vars (e.g., ${GITHUB_TOKEN})
   - Uses Bitwarden MCP to fetch secrets
   - Automatically sets env vars on local machine
4. Antigravity launches with all secrets available
```

---

## ğŸ—ï¸ Architecture Design

### Components

#### 1. Bitwarden CLI Integration

**Purpose**: Use Bitwarden CLI to fetch secrets programmatically

**Installation**: User installs Bitwarden CLI globally
```bash
npm install -g @bitwarden/cli
```

**Authentication**: Via `BW_SESSION` env var
```bash
export BW_SESSION=$(bw unlock --raw)
```

**Usage in package**: 
```bash
# Fetch secret from vault
bw get password "GITHUB_TOKEN" --session $BW_SESSION --folder "MCP Secrets"
```

**Note**: ChÃºng ta dÃ¹ng **Bitwarden CLI**, khÃ´ng pháº£i Bitwarden MCP server. MCP server lÃ  optional náº¿u user muá»‘n AI agent access Bitwarden vault (use case khÃ¡c).

#### 2. Secret Discovery Module

**Create**: `package/scripts/secret-manager.js`

**Functions**:
- `discoverRequiredSecrets()` - Scan all MCP configs, collect `${VAR}` references
- `validateBitwardenAuth()` - Check if `BW_SESSION` is set
- `fetchSecretsFromBitwarden()` - Use Bitwarden CLI/MCP to retrieve secrets
- `setEnvironmentVariables()` - Export vars to shell environment

#### 3. Installation Flow Integration

**Update**: `package/bin/cli.js`

Add new command: `ai-agent secrets sync`
- Discover required secrets from MCP configs
- Fetch from Bitwarden
- Set env vars (write to shell profile or `.env` file)

---

## ğŸ“ Detailed Workflow

### Phase 1: Initial Setup

**User Actions:**
1. Install Bitwarden CLI: `npm install -g @bitwarden/cli`
2. Login to Bitwarden: `bw login`
3. Unlock vault and set session: 
   ```bash
   export BW_SESSION=$(bw unlock --raw)
   ```
4. Store all MCP secrets in Bitwarden vault (organized by folders/items)

**Package Actions:**
1. Bundle Bitwarden MCP server in package
2. Auto-install Bitwarden MCP to Antigravity on first `ai-agent install`

### Phase 2: Secret Sync Workflow

**Command**: `ai-agent pull`

**Current behavior**: Pull skills/workflows from GitHub repo

**New behavior**: Pull + auto secret sync

**Step 1: Pull MCP Configs**
```bash
ai-agent pull
```
- Downloads `.agent/skills/`, `.agent/workflows/`, `.agent/mcp-servers/` from GitHub
- MCP configs contain `${VAR}` placeholders

**Step 2: Auto Discover Required Secrets**

Package automatically scans all MCP configs vÃ  finds:
```
ğŸ” Found required secrets:
- ${GITHUB_TOKEN}
- ${OPENAI_API_KEY}
- ${DATABASE_PASSWORD}
```

**Step 3: Check Bitwarden Session**

Validate `BW_SESSION` env var:
- âœ… If set â†’ proceed to fetch secrets
- âŒ If not â†’ show instructions:
  ```
  âš ï¸  Bitwarden session not found
  
  To sync secrets from Bitwarden:
  1. Login: bw login
  2. Unlock: export BW_SESSION=$(bw unlock --raw)
  3. Re-run: ai-agent pull
  
  Or skip secret sync for now (manual setup required)
  ```

**Step 4: Fetch Secrets from Bitwarden**

Use Bitwarden CLI:
```bash
# For each required secret:
bw get password "GITHUB_TOKEN" --session $BW_SESSION --folder "MCP Secrets"
```

Shows progress:
```
ğŸ” Fetching secrets from Bitwarden...
âœ“ GITHUB_TOKEN (found)
âœ“ OPENAI_API_KEY (found)
âš  DATABASE_PASSWORD (not found - will skip)
```

**Step 5: Set Environment Variables**

Append to `~/.zshrc` (with user consent):
```bash
First time? Add secrets to ~/.zshrc for persistence? [Y/n]: Y

âœ“ Added 2 secrets to ~/.zshrc
â„¹ï¸  Run 'source ~/.zshrc' or restart terminal to apply
```

Content added to `~/.zshrc`:
```bash
# === AI Agent MCP Secrets (auto-generated by ai-agent) ===
# Generated: 2026-02-13 13:30:00
export GITHUB_TOKEN="ghp_xxx..."
export OPENAI_API_KEY="sk-xxx..."
# === End AI Agent MCP Secrets ===
```

**Step 6: Complete**

```
âœ… Pull completed!
   Skills: 5 new
   Workflows: 2 new
   MCP Servers: 3 new
   Secrets: 2/3 synced (1 missing)

ğŸš€ Ready to use! Restart terminal or run: source ~/.zshrc
```

**Note**: KhÃ´ng cáº§n separate `ai-agent install` command - `pull` Ä‘Ã£ lÃ m má»i thá»©!

### Phase 3: Antigravity Launch

When Antigravity starts:
1. Reads `mcp_config.json`
2. Resolves `${GITHUB_TOKEN}` from environment
3. Launches GitHub MCP server with token
4. All MCP servers work seamlessly

---

## ğŸ” Implementation Details

### Secret Naming Convention

**In Bitwarden Vault:**

Organization structure:
```
Folder: MCP Secrets
â”œâ”€â”€ Item: GITHUB_TOKEN
â”‚   â””â”€â”€ Password: ghp_xxx...
â”œâ”€â”€ Item: OPENAI_API_KEY
â”‚   â””â”€â”€ Password: sk-xxx...
â””â”€â”€ Item: DATABASE_PASSWORD
    â””â”€â”€ Password: mypass123
```

**Mapping Rule**: 
- Env var name `${GITHUB_TOKEN}` â†’ Bitwarden item name `GITHUB_TOKEN`
- Use item's password field as secret value

### Bitwarden CLI Commands

**Login & Unlock:**
```bash
bw login
export BW_SESSION=$(bw unlock --raw)
```

**Fetch Secret:**
```bash
SECRET_VALUE=$(bw get password "GITHUB_TOKEN" --session $BW_SESSION)
```

**List all items** (for discovery):
```bash
bw list items --session $BW_SESSION --search "MCP Secrets"
```

### Error Handling

**Scenario 1: `BW_SESSION` not set**
```
âš ï¸  Bitwarden session not found
â„¹ï¸  Run: export BW_SESSION=$(bw unlock --raw)
```

**Scenario 2: Secret not found in Bitwarden**
```
âš ï¸  Secret GITHUB_TOKEN not found in Bitwarden vault
â„¹ï¸  Add it to Bitwarden or set manually: export GITHUB_TOKEN=...
```

**Scenario 3: Bitwarden CLI not installed**
```
âš ï¸  Bitwarden CLI not found
â„¹ï¸  Install: npm install -g @bitwarden/cli
```

---

## ğŸ¯ User Experience

### Ideal Workflow

**New Machine Setup:**
```bash
# 1. Install package
npm install -g ai-agent-config

# 2. Init with GitHub repo
ai-agent init --repo https://github.com/user/my-skills.git

# 3. Setup Bitwarden (one-time)
bw login
export BW_SESSION=$(bw unlock --raw)

# 4. Pull everything (auto secret sync)
ai-agent pull

# Output:
# ğŸ“¥ Pulling from GitHub...
# âœ“ Skills: 5 new
# âœ“ Workflows: 2 new  
# âœ“ MCP Servers: 3 new
#
# ğŸ” Scanning MCP configs for required secrets...
# Found 3 secrets: GITHUB_TOKEN, OPENAI_API_KEY, DATABASE_PASSWORD
#
# ğŸ” Fetching from Bitwarden (folder: MCP Secrets)...
# âœ“ GITHUB_TOKEN
# âœ“ OPENAI_API_KEY
# âœ“ DATABASE_PASSWORD
#
# Add secrets to ~/.zshrc for persistence? [Y/n]: Y
# âœ“ Added 3 secrets to ~/.zshrc
#
# âœ… Pull completed! Restart terminal or run: source ~/.zshrc

# 5. Apply env vars
source ~/.zshrc

# 6. Launch Antigravity - everything works! ğŸš€
```

**Daily Usage:**
```bash
# Just pull - automatically refreshes secrets + code
ai-agent pull
```

> **Note**: `pull` LUÃ”N LUÃ”N refresh secrets tá»« Bitwarden má»—i láº§n cháº¡y (náº¿u `BW_SESSION` available)

---

## âœ… Success Criteria

1. âœ… User chá»‰ cáº§n setup Bitwarden vault má»™t láº§n
2. âœ… `ai-agent secrets sync` tá»± Ä‘á»™ng fetch vÃ  set env vars
3. âœ… KhÃ´ng cáº§n hardcode secrets trong config files
4. âœ… Config files váº«n safe Ä‘á»ƒ push lÃªn GitHub public
5. âœ… Package tá»± detect `BW_SESSION` vÃ  warn náº¿u chÆ°a setup
6. âœ… Clear error messages khi secrets missing
7. âœ… Support multiple machines (secrets centralized in Bitwarden)

---

## ğŸš§ Challenges & Open Questions

### 1. Environment Variable Persistence

**Váº¥n Ä‘á»**: Khi báº¡n cháº¡y `export GITHUB_TOKEN="ghp_xxx"` trong terminal, env var nÃ y chá»‰ tá»“n táº¡i trong **session hiá»‡n táº¡i**. Khi báº¡n:
- ÄÃ³ng terminal â†’ máº¥t háº¿t
- Má»Ÿ terminal má»›i â†’ khÃ´ng cÃ³
- Restart mÃ¡y â†’ khÃ´ng cÃ³

**VÃ­ dá»¥ thá»±c táº¿:**

**Session 1** (Terminal cÅ©):
```bash
export GITHUB_TOKEN="ghp_xxx"
echo $GITHUB_TOKEN  # â†’ ghp_xxx âœ…
```

**Session 2** (Terminal má»›i):
```bash
echo $GITHUB_TOKEN  # â†’ (empty) âŒ
```

**Giáº£i phÃ¡p: Pháº£i lÆ°u env vars vÃ o file Ä‘á»ƒ persist**

CÃ³ 3 options:

**Option A: Shell Profile File** (Recommended âœ…)
- File: `~/.zshrc` (macOS/Linux vá»›i zsh) hoáº·c `~/.bashrc` (bash)
- Package tá»± Ä‘á»™ng append vÃ o cuá»‘i file:
  ```bash
  # AI Agent MCP Secrets (auto-generated)
  export GITHUB_TOKEN="ghp_xxx"
  export OPENAI_API_KEY="sk-xxx"
  ```
- âœ… **Pro**: Tá»± Ä‘á»™ng load má»—i khi má»Ÿ terminal má»›i
- âœ… **Pro**: Persistent across restarts
- âŒ **Con**: File profile trá»Ÿ nÃªn dÃ i (nhÆ°ng OK)

**Option B: Separate `.env` File**
- File: `~/.ai-agent/secrets.env`
- User pháº£i manually load: `source ~/.ai-agent/secrets.env`
- Hoáº·c: Add vÃ o profile: `source ~/.ai-agent/secrets.env`
- âœ… **Pro**: TÃ¡ch biá»‡t, dá»… manage
- âŒ **Con**: User pháº£i manually load (hoáº·c váº«n pháº£i edit profile)

**Option C: Session-Only**
- Chá»‰ `export` trong session hiá»‡n táº¡i
- âœ… **Pro**: Maximum security (khÃ´ng persist)
- âŒ **Con**: Má»—i láº§n má»Ÿ terminal pháº£i cháº¡y láº¡i `ai-agent secrets sync`

**ğŸ’¡ Recommendation: Option A** 
- Tá»± Ä‘á»™ng append vÃ o `~/.zshrc` (vá»›i user consent)
- Ask user trÆ°á»›c: "Add secrets to ~/.zshrc? (Y/n)"
- Hoáº·c: `ai-agent secrets sync --profile` Ä‘á»ƒ confirm
- Add comment block rÃµ rÃ ng Ä‘á»ƒ user dá»… tÃ¬m vÃ  xÃ³a náº¿u cáº§n

### 2. Bitwarden MCP vs Bitwarden CLI

**Challenge**: Should we use Bitwarden MCP server or Bitwarden CLI for fetching secrets?

**Bitwarden CLI** (Recommended for Phase 1):
- âœ… Simpler, well-documented
- âœ… Direct command execution
- âœ… Works in shell scripts
- âŒ Requires `bw` CLI installed

**Bitwarden MCP Server**:
- âœ… Native MCP integration
- âœ… Could leverage Antigravity's MCP support
- âŒ More complex setup
- âŒ Might require Antigravity to be running

**Recommendation**: Start with CLI, migrate to MCP later

### 3. Secret Rotation

**Challenge**: How to handle secret updates?

**Solution**:
- `ai-agent secrets sync --refresh` - refetch all secrets from Bitwarden
- User updates secret in Bitwarden â†’ re-run sync â†’ new values exported

### 4. Cross-Platform Support

**Challenge**: Shell profiles differ (zsh, bash, fish, PowerShell)

**Solution**:
- Detect shell: `echo $SHELL`
- Write to correct profile:
  - macOS/Linux: `~/.zshrc` or `~/.bashrc`
  - Windows: PowerShell profile or `.env` file

### 5. Bitwarden Vault Organization

**ğŸ’¡ Recommended Structure:**

**Trong Bitwarden Vault:**
```
ğŸ“ MCP Secrets (Folder)
   â”œâ”€â”€ ğŸ”‘ GITHUB_TOKEN
   â”‚      Type: Login
   â”‚      Password: ghp_xxx...
   â”‚
   â”œâ”€â”€ ğŸ”‘ OPENAI_API_KEY  
   â”‚      Type: Login
   â”‚      Password: sk-xxx...
   â”‚
   â””â”€â”€ ğŸ”‘ DATABASE_PASSWORD
          Type: Login
          Password: mypass123
```

**Quy táº¯c:**
1. **Folder Name**: `MCP Secrets` (fixed, package sáº½ tÃ¬m trong folder nÃ y)
2. **Item Name**: Pháº£i match chÃ­nh xÃ¡c vá»›i env var name
   - Env var: `${GITHUB_TOKEN}` â†’ Item name: `GITHUB_TOKEN`
   - Case-sensitive!
3. **Item Type**: "Login" type
4. **Field**: DÃ¹ng field `password` Ä‘á»ƒ store secret value

**Config trong package:**
```json
{
  "secrets": {
    "provider": "bitwarden",
    "folder": "MCP Secrets",
    "itemType": "login",
    "field": "password"
  }
}
```

**Táº¡i sao dÃ¹ng "Login" type?**
- Bitwarden CLI `bw get password "ITEM_NAME"` works best vá»›i Login items
- Folder organization rÃµ rÃ ng
- Dá»… manage trong Bitwarden UI

### 6. Security Considerations

**Risks**:
- âš ï¸ Env vars visible in process list (`ps aux | grep`)
- âš ï¸ Env vars persisted in shell history if typed manually
- âš ï¸ `BW_SESSION` grants full vault access

**Mitigations**:
- âœ… Use `BW_SESSION` only (no master password in env)
- âœ… Session expires after inactivity
- âœ… Recommend users lock Bitwarden when not in use
- âœ… Document security best practices

---

## ğŸš€ Implementation Phases

### Phase 1: Core Secret Management

**Scope**: Antigravity only, Bitwarden CLI-based

Tasks:
- [ ] Bundle Bitwarden MCP server in package
- [ ] Create `secret-manager.js` module
- [ ] Implement `discoverRequiredSecrets()` - scan MCP configs
- [ ] Implement `validateBitwardenAuth()` - check `BW_SESSION`
- [ ] Implement `fetchSecretsFromBitwarden()` - use `bw` CLI
- [ ] Implement `setEnvironmentVariables()` - write to shell profile
- [ ] Add CLI command: `ai-agent secrets sync`
- [ ] Add validation during `ai-agent install`

### Phase 2: User Experience Enhancements

- [ ] Interactive prompt for shell profile selection
- [ ] `--refresh` flag to update secrets
- [ ] `--dry-run` to preview changes
- [ ] Better error messages and troubleshooting
- [ ] Documentation and examples

### Phase 3: Advanced Features

- [ ] Support multiple secret providers (1Password, HashiCorp Vault)
- [ ] GUI for secret mapping (if needed)
- [ ] Auto-refresh on secret expiration
- [ ] Secret health check command
- [ ] Team sharing configurations

---

## ğŸ“š Alternative Approaches

### Option A: Manual `.env` File

**User manually creates** `~/.ai-agent/.env`:
```
GITHUB_TOKEN=ghp_xxx...
OPENAI_API_KEY=sk-xxx...
```

Package loads this file before setting env vars.

**Pros**: Simple, no Bitwarden dependency
**Cons**: Secrets in plaintext, not centralized

### Option B: Encrypted Config File

Package encrypts secrets using master password:
```bash
ai-agent secrets add GITHUB_TOKEN
# Prompt for secret value
# Encrypt with master password
# Store in ~/.ai-agent/secrets.enc
```

**Pros**: No external dependencies
**Cons**: Re-inventing password manager, less secure than Bitwarden

### Option C: OS Keychain Integration

Use macOS Keychain, Windows Credential Manager, Linux Secret Service:
```bash
ai-agent secrets add GITHUB_TOKEN --keychain
```

**Pros**: OS-native, secure
**Cons**: Platform-specific code, not cross-platform

---

## ğŸ¤” Questions for Discussion

1. **âœ… RESOLVED - Persistence**: Use shell profile (`~/.zshrc`) with user consent
2. **âœ… RESOLVED - Bitwarden Folder**: Fixed folder name `MCP Secrets`, Login item type
3. **Fallback**: If Bitwarden fails or secret not found, allow user to manually set env var?
4. **Multi-Provider**: Support 1Password, HashiCorp Vault in future? Or Bitwarden-only for now?
5. **Auto-reload**: After adding secrets to profile, should package auto `source ~/.zshrc`? (Might affect current shell state)

---

## ğŸ“– Related Resources

- [Bitwarden MCP Server](https://github.com/bitwarden/mcp-server)
- [Bitwarden CLI Docs](https://bitwarden.com/help/cli/)
- [MCP Auth Spec](https://modelcontextprotocol.io/docs/concepts/authentication)
- [Environment Variable Best Practices](https://12factor.net/config)

---

**Next Steps:**
1. â³ Get user feedback on brainstorm
2. â³ Decide on persistence strategy
3. â³ Prototype `secret-manager.js` module
4. â³ Test Bitwarden CLI integration
5. â³ Create detailed implementation plan
